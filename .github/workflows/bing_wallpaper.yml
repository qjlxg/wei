name: ğŸ–¼ï¸ Download Bing Daily Image

# 1. è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # è„šæœ¬æ–‡ä»¶æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘ (æ³¨æ„è¿™é‡Œç§»é™¤äº†å¯¹ requirements.txt çš„è·Ÿè¸ª)
  push:
    paths:
      - 'download_bing_images.py'
      - '.github/workflows/bing_wallpaper.yml'
  
  # æ¯æ—¥å®šæ—¶è§¦å‘ (ä¸Šæµ·æ—¶åŒº 10:00)
  schedule:
    - cron: '0 2 * * *' 

# 2. ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai
  
# 3. ä½œä¸š (Jobs)
jobs:
  download_and_commit:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # æ­¥éª¤ 2: è®¾ç½® Python ç¯å¢ƒ
      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # æ­¥éª¤ 3: â— å®‰è£…requestsåº“ (æ›¿æ¢äº† requirements.txt)
      - name: ğŸ“¦ Install requests dependency
        run: pip install requests

      # æ­¥éª¤ 4: è¿è¡Œä¸‹è½½è„šæœ¬
      - name: ğŸš€ Run download script
        run: python download_bing_images.py

      # æ­¥éª¤ 5: é…ç½® Git
      - name: ğŸ‘¤ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      # æ­¥éª¤ 6: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å›¾ç‰‡æ–‡ä»¶
      - name: ğŸ” Check for changes
        id: git_status
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶æˆ–ä¿®æ”¹çš„æ–‡ä»¶
        run: |
          if git diff --exit-code --name-only > /dev/null; then
            echo "commit_needed=false" >> $GITHUB_OUTPUT
          else
            echo "commit_needed=true" >> $GITHUB_OUTPUT
          fi
          
      # æ­¥éª¤ 7: æäº¤å’Œæ¨é€ (ä»…åœ¨æœ‰æ–°æ–‡ä»¶æ—¶æ‰§è¡Œ)
      - name: ğŸ“¤ Commit and Push if needed
        if: steps.git_status.outputs.commit_needed == 'true'
        run: |
          git add .
          # ä½¿ç”¨ä¸Šæµ·æ—¶åŒºçš„æ—¶é—´ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")
          git commit -m "ğŸ–¼ï¸ Bing Daily Image: ${COMMIT_TIME} (Shanghai)"
          git push
