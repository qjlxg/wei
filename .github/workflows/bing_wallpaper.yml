name: ğŸ–¼ï¸ ZSH Bing Image Fetcher

# 1. è§¦å‘æ¡ä»¶
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘
  push:
    paths:
      - 'fetch_bing_images.zsh'
      - '.github/workflows/bing_zsh_fetch.yml'
  
  # æ¯æ—¥å®šæ—¶è§¦å‘ (UTC 2:00 -> ä¸Šæµ·æ—¶åŒº 10:00)
  schedule:
    - cron: '0 2 * * *' 

# 2. ç¯å¢ƒå˜é‡ (ç”¨äº Git æäº¤æ¶ˆæ¯çš„æ—¶é—´æˆ³)
env:
  TZ: Asia/Shanghai
  
jobs:
  download_and_commit:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç  (å¿…é¡»è·å–å†å²è®°å½•)
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      # æ­¥éª¤ 2: å®‰è£…ä¾èµ– (xmllint/libxml2 å’Œ zsh)
      - name: ğŸ“¦ Install dependencies (zsh, libxml2)
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh libxml2-utils curl
          
      # æ­¥éª¤ 3: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
      - name: ğŸ” Set script permissions
        run: chmod +x fetch_bing_images.zsh

      # æ­¥éª¤ 4: è¿è¡Œ Zsh ä¸‹è½½è„šæœ¬ (æŠ“å–å½“å¤©çš„å›¾ç‰‡)
      - name: ğŸš€ Run Zsh fetch script
        # ä½¿ç”¨ zsh è¿è¡Œè„šæœ¬
        run: zsh ./fetch_bing_images.zsh
        
      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶æˆ–å˜åŠ¨
      - name: ğŸ” Check for changes
        id: git_status
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          if git status --porcelain | grep -q 'A\|M'; then
            echo "commit_needed=true" >> $GITHUB_OUTPUT
          else
            echo "commit_needed=false" >> $GITHUB_OUTPUT
          fi
          
      # æ­¥éª¤ 6: æäº¤å’Œæ¨é€ (ä»…åœ¨æœ‰æ–°æ–‡ä»¶æ—¶æ‰§è¡Œ)
      - name: ğŸ“¤ Commit and Push if needed
        if: steps.git_status.outputs.commit_needed == 'true'
        run: |
          git add bing_images metadata
          # è·å–ä¸Šæµ·æ—¶åŒºä»Šå¤©çš„æ—¥æœŸä½œä¸ºæäº¤ä¿¡æ¯
          COMMIT_DATE=$(TZ=Asia/Shanghai date +"%Y-%m-%d")
          git commit -m "Fetch: Bing Images ${COMMIT_DATE} (Multi-Mkt)"
          git push
          
      # æ­¥éª¤ 7: è¿è¡Œå†å²å›¾ç‰‡è„šæœ¬ (å¯é€‰ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶å¯ä½¿ç”¨å‚æ•°)
      # å¦‚æœæ‚¨éœ€è¦ä¸‹è½½å†å²å›¾ç‰‡ï¼Œå¯ä»¥åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æŒ‡å®š idx å‚æ•°ï¼Œä¾‹å¦‚ï¼š
      # - name: ğŸš€ Run Zsh fetch script for history (idx=8)
      #   if: github.event_name == 'workflow_dispatch' 
      #   run: zsh ./fetch_bing_images.zsh 8
