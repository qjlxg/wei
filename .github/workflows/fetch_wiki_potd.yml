name: ğŸ“¸ Fetch Wikipedia Picture of the Day

# è§¦å‘æ¡ä»¶
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # 2. å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'fetch_wiki_image.py'
      - '.github/workflows/fetch_wiki_potd.yml'

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨äºè®¾å®šæ—¶åŒº
env:
  TZ: Asia/Shanghai # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº

jobs:
  fetch_and_commit:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        # å¯ç”¨ 'fetch-depth: 0' ä»¥ç¡®ä¿èƒ½æ­£ç¡®æ¨é€ (éå¿…é¡»ï¼Œä½†æ¨èç”¨äºå¤æ‚çš„ git æ“ä½œ)
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ–
      - name: âš™ï¸ Install dependencies
        run: pip install requests pytz

      # 4. è¿è¡Œ Python è„šæœ¬
      - name: ğŸš€ Run script to fetch data
        # è„šæœ¬å°†ç”Ÿæˆ YYYY/MM/YYYY-MM-DD-HH-MM-SS.txt æ–‡ä»¶
        run: python fetch_wiki_image.py

      # 5. Git é…ç½® (å¿…é¡»ï¼Œç”¨äºæ ‡è¯†æäº¤è€…)
      - name: ğŸ‘¤ Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          
      # 6. æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶ç”Ÿæˆæˆ–å˜åŠ¨
      - name: ğŸ” Check for changes
        id: git_status
        run: |
          # æ£€æŸ¥æš‚å­˜åŒºå’Œå·¥ä½œç›®å½•ä¸­æ˜¯å¦æœ‰æœªæäº¤çš„å˜åŠ¨ (å³æ–°ç”Ÿæˆçš„æ–‡ä»¶)
          if git diff --quiet && git diff --staged --quiet; then
            echo "::set-output name=has_changes::false"
          else
            echo "::set-output name=has_changes::true"
          fi
        # æ³¨æ„: set-output åœ¨ actions/checkout@v4 ä¸­å·²è¢«å¼ƒç”¨ï¼Œä½†åœ¨è®¸å¤šæ—§æ•™ç¨‹ä¸­ä»ä½¿ç”¨ã€‚
        # å®é™…é¡¹ç›®ä¸­åº”ä½¿ç”¨ $GITHUB_OUTPUTï¼Œä¸ºç®€æ´èµ·è§ï¼Œæ­¤å¤„ä¿ç•™ç»å…¸å†™æ³•ï¼Œä½†éœ€æ³¨æ„å…¼å®¹æ€§ã€‚
        # æ¨èçš„å†™æ³•æ˜¯ï¼šecho "has_changes=true" >> $GITHUB_OUTPUT

      # 7. æäº¤å¹¶æ¨é€æ–°æ–‡ä»¶ (ä»…å½“æœ‰å˜åŠ¨æ—¶)
      - name: ğŸ“¤ Commit and push new file
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ–°ç”Ÿæˆçš„æ–‡ä»¶
          git add .
          
          # åˆ›å»ºæäº¤ä¿¡æ¯ï¼ŒåŒ…å«æ—¥æœŸå’Œæ—¶é—´
          COMMIT_MESSAGE="feat: Add Wikipedia Picture of the Day for $(TZ='Asia/Shanghai' date +'%Y-%m-%d')"
          
          # æäº¤
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€å›ä»“åº“
          git push
