name: ğŸ“¸ Fetch Wikimedia Picture of the Day

# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # 2. å½“æŒ‡å®šçš„è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'fetch_wiki_image.py'
      - '.github/workflows/fetch_wiki_potd.yml'

# è®¾ç½®ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai # è®¾ç½®å·¥ä½œæµä¸­çš„æ—¶é—´åŸºå‡†ä¸ºä¸Šæµ·æ—¶åŒº (Asia/Shanghai)

jobs:
  fetch_and_commit:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ Checkout repository (è·å–å®Œæ•´å†å²ç”¨äºæ¨é€)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ– (requests å’Œ pytz)
      - name: âš™ï¸ Install dependencies
        run: pip install requests pytz

      # 4. è¿è¡Œ Python è„šæœ¬
      - name: ğŸš€ Run script to fetch and download data
        # è„šæœ¬å°†åˆ›å»º wiki_image/YYYY/MM/YYYY-MM-DD.ext æ–‡ä»¶
        run: python fetch_wiki_image.py

      # 5. Git é…ç½® (å¿…é¡»ï¼Œç”¨äºæ ‡è¯†æäº¤è€…èº«ä»½)
      - name: ğŸ‘¤ Configure Git User
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          
      # 6. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨å¹¶å‡†å¤‡æäº¤
      - name: ğŸ“ Stage changes and Check for changes
        id: stage
        run: |
          # æ·»åŠ  BASE_DOWNLOAD_DIR ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆå¦‚æœæœ‰æ–°ä¸‹è½½çš„æ–‡ä»¶ï¼‰
          git add .
          
          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦ä¸ºç©ºã€‚
          if git diff --cached --quiet; then
            echo "::set-output name=has_changes::false"
          else
            echo "::set-output name=has_changes::true"
          fi

      # 7. æäº¤å¹¶æ¨é€æ–°æ–‡ä»¶ (ä»…å½“æœ‰å˜åŠ¨æ—¶)
      - name: ğŸ“¤ Commit and push new file
        if: steps.stage.outputs.has_changes == 'true'
        run: |
          # æäº¤ä¿¡æ¯åæ˜ è¿™æ˜¯æ‰¹é‡/å¢é‡æ›´æ–°
          COMMIT_MESSAGE="feat: Incremental update of POTD archive up to $(TZ='Asia/Shanghai' date +'%Y-%m-%d')"
          
          # æäº¤
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€å›ä»“åº“
          git push
