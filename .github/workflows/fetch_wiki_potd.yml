name: ğŸ“¸ Fetch Wikimedia Picture of the Day

# å®šä¹‰å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # 1. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:
  # 2. å½“æŒ‡å®šçš„è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'fetch_wiki_image.py'
      - '.github/workflows/fetch_wiki_potd.yml'

# è®¾ç½®ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai # è®¾ç½®å·¥ä½œæµä¸­çš„æ—¶é—´åŸºå‡†ä¸ºä¸Šæµ·æ—¶åŒº

jobs:
  fetch_and_commit:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: â¬‡ï¸ Checkout repository (è·å–å®Œæ•´å†å²ç”¨äºæ¨é€)
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 ç¡®ä¿è·å–å®Œæ•´ Git å†å²ï¼Œè¿™å¯¹åç»­çš„ git push æ˜¯å¿…è¦çš„
          fetch-depth: 0 

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3. å®‰è£…ä¾èµ– (requests ç”¨äºç½‘ç»œè¯·æ±‚ï¼Œpytz ç”¨äºæ—¶åŒºå¤„ç†)
      - name: âš™ï¸ Install dependencies
        run: pip install requests pytz

      # 4. è¿è¡Œ Python è„šæœ¬
      - name: ğŸš€ Run script to fetch and download data
        # è„šæœ¬å°†åˆ›å»º YYYY/MM/YYYY-MM-DD-HH-MM-SS.ext (å›¾ç‰‡) å’Œ YYYY/MM/YYYY-MM-DD-HH-MM-SS_meta.txt (å…ƒæ•°æ®)
        run: python fetch_wiki_image.py

      # 5. Git é…ç½® (å¿…é¡»ï¼Œç”¨äºæ ‡è¯†æäº¤è€…èº«ä»½)
      - name: ğŸ‘¤ Configure Git User
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions-bot@users.noreply.github.com"
          
      # 6. æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶ç”Ÿæˆæˆ–å˜åŠ¨
      - name: ğŸ” Check for changes
        id: git_status
        run: |
          # æ£€æŸ¥å·¥ä½œç›®å½•ä¸­æ˜¯å¦æœ‰æœªæäº¤çš„æ–°æ–‡ä»¶ï¼ˆå³è„šæœ¬ç”Ÿæˆçš„æ–‡ä»¶ï¼‰
          if git diff --quiet && git diff --staged --quiet; then
            echo "::set-output name=has_changes::false"
          else
            echo "::set-output name=has_changes::true"
          fi

      # 7. æäº¤å¹¶æ¨é€æ–°æ–‡ä»¶ (ä»…å½“æœ‰å˜åŠ¨æ—¶)
      - name: ğŸ“¤ Commit and push new file
        # ä»…å½“æ­¥éª¤ 6 æ£€æµ‹åˆ°æ–‡ä»¶å˜åŠ¨æ—¶æ‰æ‰§è¡Œ
        if: steps.git_status.outputs.has_changes == 'true'
        run: |
          # æ·»åŠ æ‰€æœ‰æ–°ç”Ÿæˆçš„æ–‡ä»¶
          git add .
          
          # åˆ›å»ºæäº¤ä¿¡æ¯ï¼ŒåŒ…å«æ—¥æœŸ
          COMMIT_MESSAGE="feat: Add POTD for $(TZ='Asia/Shanghai' date +'%Y-%m-%d')"
          
          # æäº¤
          git commit -m "$COMMIT_MESSAGE"
          
          # æ¨é€å›ä»“åº“
          git push
