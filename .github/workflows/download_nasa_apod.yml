name: Download NASA APOD Daily Image

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ
    # å…è®¸è¾“å…¥ä¸€ä¸ªå‚æ•°æ¥è§¦å‘â€œæ‰¹é‡ä¸‹è½½â€æ¨¡å¼
    inputs:
      batch_download:
        description: 'æ˜¯å¦è¿è¡Œå†å²æ‰¹å¤„ç†ä¸‹è½½ (ç”¨äºé¦–æ¬¡è¿è¡Œ)'
        required: false
        default: 'false'
        type: boolean
  
  # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼ˆä¾‹å¦‚ï¼ŒUTC æ—¶é—´ 03:00ï¼‰
  schedule:
    - cron: '0 3 * * *'
    
  push:
    branches:
      - main
    paths:
      - 'nasa_apod.py'
      - '.github/workflows/download_nasa_apod.yml'

env:
  TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒº

jobs:
  download-and-push:
    runs-on: ubuntu-latest
    # ã€æ–°å¢ã€‘è®¾ç½®ä½œä¸šè¶…æ—¶æ—¶é—´ï¼Œä»¥é€‚åº”é•¿æ—¶é—´çš„å†å²æ‰¹é‡ä¸‹è½½
    timeout-minutes: 60 
    
    outputs:
      commit_needed: ${{ steps.run-script.outputs.commit_needed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run NASA APOD download script
        id: run-script # æ ‡è®°æ­¤æ­¥éª¤ä»¥æ•è·è„šæœ¬è¾“å‡º
        # ä¼ é€’ NASA_API_KEY Secret ä½œä¸ºç¯å¢ƒå˜é‡
        env:
          NASA_API_KEY: ${{ secrets.NASA_API_KEY }}
        run: python nasa_apod.py

      - name: Commit and push downloaded images
        # ä»…å½“ Python è„šæœ¬è¾“å‡º 'commit_needed: true' æ—¶æ‰§è¡Œæ­¤æ­¥éª¤
        if: steps.run-script.outputs.commit_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # ã€ä¼˜åŒ–ã€‘ä½¿ç”¨ git status åˆ¤æ–­æ˜¯å¦æœ‰å¤§é‡æ–‡ä»¶å˜åŠ¨
          # å¦‚æœæ–°å¢çš„æ–‡ä»¶è¶…è¿‡ 10 ä¸ªï¼Œåˆ™å‡å®šä¸ºæ‰¹é‡ä¸‹è½½
          NEW_FILES=$(git status --porcelain | grep 'nasa_apod_wallpapers/' | wc -l)
          
          if [ "$NEW_FILES" -gt "10" ]; then
            COMMIT_MESSAGE="ğŸš€ Initial/Batch download of NASA APOD (+$NEW_FILES files)"
          else
            COMMIT_MESSAGE="âœ¨ Add daily NASA APOD - $(date +'%Y-%m-%d')"
          fi

          # ç¡®ä¿æ‰€æœ‰æ–°å¢çš„æ–‡ä»¶å’Œç›®å½•éƒ½è¢«è¿½è¸ª
          git add nasa_apod_wallpapers/
          
          # æäº¤å¹¶æ¨é€
          git commit -m "$COMMIT_MESSAGE"
          git push
        env:
          # ä½¿ç”¨å†…ç½® token è¿›è¡Œè®¤è¯å’Œæ¨é€
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}